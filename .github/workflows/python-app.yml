# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: Python application

on:
  workflow_dispatch:
  push:
    branches: [ "main", "dev" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

env:
  PYTHONPATH: .
  APP__PG__HOST: localhost
  APP__PG__PORT: 5434
  APP__PG__LOGIN: ${{ secrets.APP__PG__LOGIN }}
  APP__PG__PASSWORD: ${{ secrets.APP__PG__PASSWORD }}
  APP__PG__BASE_DB: db

  APP__LDAP__HOST: localhost
  APP__LDAP__PORT: 389
  APP__LDAP__LOGIN: cn=admin,dc=mycompany,dc=local
  APP__LDAP__PASSWORD: ${{ secrets.APP__LDAP__PASSWORD }}
  APP__LDAP__BASE_DN: dc=mycompany,dc=local
  APP__LDAP__ORGANISATION: MyCompany
  APP__LDAP__DOMAIN: mycompany.local
  
  APP__WEB__JWT__ACCESS_EXPIRE: 1
  APP__WEB__JWT__SECRET_KEY: ${{ secrets.APP__WEB__JWT__SECRET_KEY }}
  APP__WEB__JWT__ALGORITHM: HS256

jobs:
  # lint:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v4
  #   - name: Install python
  #     uses: actions/setup-python@v6
  #     with:
  #       python-version: '3.13'
  #   - name: Install dependencies
  #     run: |
  #       python -m pip install --upgrade pip
  #       pip install pytest poetry
  #       python -m poetry install --no-root
  #   - name: Ruff check
  #     run: poetry run ruff check .
  # tests:
  #   runs-on: ubuntu-latest
  #   needs: lint
  #   steps:
  #   - uses: actions/checkout@v4
  #   - name: Install python
  #     uses: actions/setup-python@v6
  #     with:
  #       python-version: "3.13"
  #   - name: Install dependencies
  #     run: |
  #       python -m pip install --upgrade pip
  #       pip install pytest poetry
  #       python -m poetry install --no-root
  #   - name: Test with pytest
  #     run: |
  #       poetry run pytest -vv

  deploy:
    #needs: tests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SERVER_PRIVATE_KEY }}

    - name: Add server to known_hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan " ${{secrets.SERVER_HOST}}" >> ~/.ssh/known_hosts
        chmod 600 ~/.ssh/known_hosts
    - name: Rsync project
      run: |
        set -e
        ls -la "${GITHUB_WORKSPACE}"
        rsync -az --delete \
          --exclude=".git" \
          --exclude=".github" \
          -e "ssh -o StrictHostKeyChecking=accept-new" \
          "${GITHUB_WORKSPACE}/" "${{secrets.SERVER_USER}}@${{secrets.SERVER_HOST}}:/home/${{secrets.SERVER_USER}}/atom-test-ldap/"
    - name: Deploy in remote server
      run: |
        ssh -o StrictHostKeyChecking=accept-new "${{secrets.SERVER_USER}}@${{secrets.SERVER_HOST}}" bash -lc '
          cd /home/${secrets.SERVER_USER}/atom-test-ldap
          export APP__PG__HOST="${APP__PG__HOST}"
          export APP__PG__PORT="${APP__PG__PORT}"
          export APP__PG__LOGIN="${APP__PG__LOGIN}"
          export APP__PG__PASSWORD="${APP__PG__PASSWORD}"
          export APP__PG__BASE_DB="${APP__PG__BASE_DB}"
          export APP__LDAP__HOST="${APP__LDAP__HOST}"
          export APP__LDAP__PORT="${APP__LDAP__PORT}"
          export APP__LDAP__LOGIN="${APP__LDAP__LOGIN}"
          export APP__LDAP__PASSWORD="${APP__LDAP__PASSWORD}"
          export APP__LDAP__BASE_DN="${APP__LDAP__BASE_DN}"
          export APP__LDAP__ORGANISATION="${APP__LDAP__ORGANISATION}"
          export APP__LDAP__DOMAIN="${APP__LDAP__DOMAIN}"
          export APP__WEB__JWT__ACCESS_EXPIRE="${APP__WEB__JWT__ACCESS_EXPIRE}"
          export APP__WEB__JWT__SECRET_KEY="${APP__WEB__JWT__SECRET_KEY}"
          export APP__WEB__JWT__ALGORITHM="${APP__WEB__JWT__ALGORITHM}"
          docker compose pull
          docker compose up -d --remove-orphans
        '
  notify_success:
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    steps:
      - name: Send success message
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TG_CHAT_ID }}
          token: ${{ secrets.TG_API_KEY }}
          format: markdown
          message: |
            âœ… *Success Deploy new Commit on server ${{secrets.SERVER_HOST}}* 

            `branch:` ${{ github.ref_name }} 
            `author:` ${{ github.event.pusher.name }}
            `message:` ${{ github.event.head_commit.message }}

            See changes: https://github.com/${{ github.repository }}/commit/${{github.sha}}


    
