# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: Python application

on:
  workflow_dispatch:
  push:
    branches: [ "main", "dev" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

env:
  PYTHONPATH: .\
  APP__CONFIG: "env/pod.env"
  APP__PG__LOGIN: ${{ secrets.APP__PG__LOGIN }}
  APP__PG__PASSWORD: ${{ secrets.APP__PG__PASSWORD }}

  APP__LDAP__LOGIN: cn=admin,dc=mycompany,dc=local
  APP__LDAP__PASSWORD: ${{ secrets.APP__LDAP__PASSWORD }}
  
  APP__WEB__JWT__SECRET_KEY: ${{ secrets.APP__WEB__JWT__SECRET_KEY }}

  SERVER_PRIVATE_KEY: ${{ secrets.SERVER_PRIVATE_KEY }}
  SERVER_USER: ${{secrets.SERVER_USER}}
  SERVER_HOST: ${{secrets.SERVER_HOST}}

  SERVER_PATH: /home/${{secrets.SERVER_USER}}/atom-test-ldap/

jobs:
  # lint:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v4
  #   - name: Install python
  #     uses: actions/setup-python@v6
  #     with:
  #       python-version: '3.13'
  #   - name: Install dependencies
  #     run: |
  #       python -m pip install --upgrade pip
  #       pip install pytest poetry
  #       python -m poetry install --no-root
  #   - name: Ruff check
  #     run: poetry run ruff check .
  # tests:
  #   runs-on: ubuntu-latest
  #   needs: lint
  #   steps:
  #   - uses: actions/checkout@v4
  #   - name: Install python
  #     uses: actions/setup-python@v6
  #     with:
  #       python-version: "3.13"
  #   - name: Install dependencies
  #     run: |
  #       python -m pip install --upgrade pip
  #       pip install pytest poetry
  #       python -m poetry install --no-root
  #   - name: Test with pytest
  #     run: |
  #       poetry run pytest -vv

  deploy:
    #needs: tests
    if: success()
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{env.SERVER_PRIVATE_KEY}}
    - name: Rsync project
      run: |
        set -e
        rsync -az --delete \
          --exclude=".git" \
          --exclude=".github" \
          --exclude='ldap_config' \
          --exclude='ldap_data' \
          --no-owner --no-group --omit-dir-times \
          -e "ssh -o StrictHostKeyChecking=accept-new" \
          "${GITHUB_WORKSPACE}/" "${{env.SERVER_USER}}@${{env.SERVER_HOST}}:${{env.SERVER_PATH}}"
    - name: Build .env on runner
      run: |
        umask 177; mkdir -p env
        {
          echo "APP__CONFIG=${{env.APP__CONFIG}}"
          echo "APP__PG__LOGIN=${{ env.APP__PG__LOGIN}}"
          echo "APP__PG__PASSWORD=${{ env.APP__PG__PASSWORD}}"
          echo "APP__LDAP__LOGIN=${{ env.APP__LDAP__LOGIN}}"
          echo "APP__LDAP__PASSWORD=${{ env.APP__LDAP__PASSWORD}}"
          echo "APP__WEB__JWT__SECRET_KEY=${{ env.APP__WEB__JWT__SECRET_KEY}}"
        } >> ${{env.APP__CONFIG}}
    - name: Upload .env to server
      run: |
        scp -o StrictHostKeyChecking=accept-new ${{env.APP__CONFIG}} "${{env.SERVER_USER}}@${{env.SERVER_HOST}}:${{env.SERVER_PATH}}"
    - name: Deploy with compose (uses the file)
      run: |
        ssh -o StrictHostKeyChecking=accept-new "${{env.SERVER_USER}}@${{env.SERVER_HOST}}" "bash -lc '
          cd ${{env.SERVER_PATH}}
          docker compose --env-file ./${{env.APP__CONFIG}} pull
          docker compose --env-file ./${{env.APP__CONFIG}} up -d --remove-orphans
        '"
  notify_success:
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    steps:
      - name: Send success message
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TG_CHAT_ID }}
          token: ${{ secrets.TG_API_KEY }}
          format: markdown
          message: |
            âœ… *Success Deploy new Commit on server ${{secrets.SERVER_HOST}}* 

            `branch:` ${{ github.ref_name }} 
            `author:` ${{ github.event.pusher.name }}
            `message:` ${{ github.event.head_commit.message }}

            See changes: https://github.com/${{ github.repository }}/commit/${{github.sha}}


    
